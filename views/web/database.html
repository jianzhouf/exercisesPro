<% include ../layout/header.html %>
<% include ../layout/menus.html %>

<!--<h1>Welcome <%= user.username %>, 欢迎来到数据中心！</h1>-->
<div class="container">
    <div class="table-btns">
        <form action="">
            <select id="select-z" class="search-z" style="width: 200px;">
            </select>
            <button type="button" id="query-z" class="btn btn-default">查询</button>
        </form>
    </div>
    <div id="database">
        <table class="table table-bordered">
            <thead>
            <tr>
                <th class="col-sm-1"></th>
                <th class="col-sm-3">类别</th>
                <th class="col-sm-3">收入</th>
                <th class="col-sm-3">支出</th>
                <th class="col-sm-2">日期</th>
            </tr>
            </thead>
            <tbody id="table-content">
            </tbody>
        </table>
    </div>

    <div class="pagination">
        <a href="#" class="first" data-action="first">&laquo;</a>
        <a href="#" class="previous" data-action="previous">&lsaquo;</a>
        <input type="text" readonly="readonly"/>
        <a href="#" class="next" data-action="next">&rsaquo;</a>
        <a href="#" class="last" data-action="last">&raquo;</a>
    </div>
</div>
<script>
    var params = {
        currentPage: 1
    };

    function tableResponse(params, url) {
        $.ajax({
            type: "post",
            dataType: "json",
            url: url,
            data: params,
            success: function (data) {
                tableInit(data.data, params, parseInt(data.data.length / 10) + 1, url);
            }
        });
    }

    function tableInit(data, params, maxPage, url) {

        var page = params.currentPage;
        if (data.length == 0) {
            $("#table-content").html('<tr><td colspan="5">找不到数据</td></tr>')
        } else {
            $("#table-content").empty();
            var len = (page - 1) * 10 + 10;
            if (len > data.length) {
                len = data.length;
            }
            for (var i = (page - 1) * 10; i < len; i++) {
                if (data[i].income < data[i].spending) {
                    $("#table-content").append('<tr class="over"><td>' + (i + 1) + '</td><td>'
                        + data[i].category + '</td><td>'
                        + data[i].income + '</td><td>'
                        + data[i].spending + '(超支)</td><td>'
                        + data[i].date
                        + '</td></tr>');
                } else {
                    $("#table-content").append('<tr><td >' + (i + 1) + '</td><td>'
                        + data[i].category + '</td><td>'
                        + data[i].income + '</td><td>'
                        + data[i].spending + '</td><td>'
                        + data[i].date
                        + '</td></tr>');
                }

            }
            //生成类别选择框
            if (!params.category) {
                for (var i = 0, select = []; i < data.length; i++) {
                    select[data[i].category] = 1;
                }
                $("#select-z").empty();
                $("#select-z").append("<option value=''>全部</option>");
                for (var key in select) {
                    $("#select-z").append("<option value='" + key + "'>" + key + "</option>")
                }
            }


            //分页组件
            $('.pagination').jqPagination({
                link_string: '/?page={page_number}',
                max_page: maxPage,
                paged: function (page) {
                    tableResponse({currentPage: page}, url);
                }
            });
        }
    }

    tableResponse(params, "../javascripts/aTest.json");

    $("#query-z").click(function () {

        if ($("#select-z").val() !== "") {
            params.category = $("#select-z").val();
        } else {
            delete params.category;
        }

        tableResponse(params, "../javascripts/aTest.json");
    });
</script>
<% include ../layout/footer.html %>